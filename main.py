import os
import time
import csv
from flask import Flask, request
import telebot
from threading import Thread

API_TOKEN = os.environ.get("BOT_TOKEN")
bot = telebot.TeleBot(API_TOKEN)
app = Flask(__name__)

TRIGGER_WORDS = ["–∫–æ–¥", "—Ö–æ—á—É", "—Å–µ—Å—Å–∏—è", "—Å–∫–∏–¥–∫–∞", "–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ"]
USERS_DB = "clients.csv"

# –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –¥–ª—è –±–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–æ–≤
if not os.path.exists(USERS_DB):
    with open(USERS_DB, mode='w', newline='', encoding='utf-8') as file:
        writer = csv.writer(file)
        writer.writerow(["User ID", "–ò–º—è", "Username", "–°–æ–æ–±—â–µ–Ω–∏–µ", "–í—Ä–µ–º—è"])

# –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
def save_user_info(message):
    with open(USERS_DB, mode='a', newline='', encoding='utf-8') as file:
        writer = csv.writer(file)
        writer.writerow([
            message.from_user.id,
            message.from_user.first_name,
            message.from_user.username,
            message.text,
            time.strftime('%Y-%m-%d %H:%M:%S')
        ])

# –°—Ç–∞—Ä—Ç–æ–≤—ã–π –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç
@bot.message_handler(func=lambda msg: any(word in msg.text.lower() for word in TRIGGER_WORDS))
def handle_trigger(msg):
    user_name = msg.from_user.first_name
    save_user_info(msg)

    # –ë–ª–æ–∫ 1: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    bot.send_message(msg.chat.id, f"\U0001F31F –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {user_name}!
\n–≠—Ç–æ –ê–Ω–∞—Å—Ç–∞—Å–∏—è –ì–∞–≤—Ä–∏–ª–æ–≤–∞, –∞–≤—Ç–æ—Ä –º–µ—Ç–æ–¥–∞ '–ö–≤–∞–Ω—Ç–æ–≤—ã–π –∫–æ–¥ –∏–∑–æ–±–∏–ª–∏—è'.\n\n–ë–ª–∞–≥–æ–¥–∞—Ä—é –∑–∞ –≤–∞—à –∏–Ω—Ç–µ—Ä–µ—Å –∫ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏! ‚ú®\n\n–£ –º–µ–Ω—è –¥–ª—è –≤–∞—Å —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ - —Å–∫–∏–¥–∫–∞ 20% –¥–µ–π—Å—Ç–≤—É–µ—Ç –µ—â—ë 3 –¥–Ω—è.\n\n–ß–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ —è –æ—Ç–ø—Ä–∞–≤–ª—é –≤–∞–º –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Å—Å–∏–∏.\n\n–ê –ø–æ–∫–∞ —Å–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞:\n- –í –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –≤–∞–º —É–¥–æ–±–Ω–µ–µ –æ–±—â–∞—Ç—å—Å—è?\n- –ö–∞–∫–æ–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ –¥–ª—è —Å–≤—è–∑–∏?")

    # –û—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥)
    def send_info_block():
        time.sleep(10)
        bot.send_message(msg.chat.id, "\U0001F4CB –¢–†–ê–ù–°–§–û–†–ú–ê–¶–ò–û–ù–ù–ê–Ø –°–ï–°–°–ò–Ø '–†–ê–°–ö–†–´–¢–ò–ï –ö–û–î–ê –ò–ó–û–ë–ò–õ–ò–Ø'\n\n‚è± –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 90 –º–∏–Ω—É—Ç\nüí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: 12,000‚ÇΩ –≤–º–µ—Å—Ç–æ 15,000‚ÇΩ (—Å–∫–∏–¥–∫–∞ 20%)\nüìÖ –§–æ—Ä–º–∞—Ç: –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ, –æ–Ω–ª–∞–π–Ω\n\n–ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–µ–º –Ω–∞ —Å–µ—Å—Å–∏–∏:\n‚úÖ –†–∞—Å—à–∏—Ñ—Ä—É–µ–º –≤–∞—à —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–æ–¥\n‚úÖ –í—ã—è–≤–∏–º –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ–º –≥–ª–∞–≤–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–ª–æ–∫\n‚úÖ –°–æ–∑–¥–∞–¥–∏–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∏–∑–æ–±–∏–ª–∏—è\n‚úÖ –ü—Ä–æ–≤–µ–¥—ë–º –≥–ª—É–±–∏–Ω–Ω—É—é —Ä–∞–±–æ—Ç—É —Å –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏–µ–º\n\n–ß—Ç–æ–±—ã —è –º–æ–≥–ª–∞ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–∞–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—É—é —Å–µ—Å—Å–∏—é, –æ—Ç–≤–µ—Ç—å—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞ 3 –≤–æ–ø—Ä–æ—Å–∞:\n1. –ö–∞–∫–∞—è –≤–∞—à–∞ –≥–ª–∞–≤–Ω–∞—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∑–∞–¥–∞—á–∞ —Å–µ–π—á–∞—Å?\n2. –ö–∞–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü?\n3. –†–∞–±–æ—Ç–∞–ª–∏ –ª–∏ –≤—ã —Ä–∞–Ω—å—à–µ —Å –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏–µ–π –∏–ª–∏ —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø—Ä–∞–∫—Ç–∏–∫–∞–º–∏?")

    Thread(target=send_info_block).start()

# –í–µ–±—Ö—É–∫
@app.route(f"/{API_TOKEN}", methods=["POST"])
def webhook():
    json_str = request.get_data().decode("UTF-8")
    update = telebot.types.Update.de_json(json_str)
    bot.process_new_updates([update])
    return "ok", 200

@app.route("/")
def set_webhook():
    bot.remove_webhook()
    bot.set_webhook(url=f"{os.environ.get('RENDER_URL')}/{API_TOKEN}")
    return "Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω", 200

if __name__ == '__main__':
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 5000)))
